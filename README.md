# 植物识别模型一致性修复说明

## 📋 问题诊断

原始问题：Plant Model1 中的原模型与当前页面预测结果不一致。

## 🔍 发现的问题

经过分析，发现以下可能导致预测结果不一致的原因：

1. **图像预处理不一致**
   - 原代码只进行简单的 [0,1] 归一化
   - 缺少标准化处理（mean/std normalization）
   - 可能与训练时的预处理方式不匹配

2. **缺少调试信息**
   - 无法查看中间处理步骤
   - 难以定位问题根源

3. **模型加载方式**
   - 没有明确记录使用的模型类型
   - 缺少验证步骤

## ✅ 已实施的修复

### 1. 增强的图像预处理

添加了三种预处理模式，可在界面上切换：

- **简单归一化 [0,1]** (推荐，默认)
  - 将像素值从 [0,255] 归一化到 [0,1]
  - 适用于大多数 TensorFlow.js 模型

- **ImageNet 标准化**
  - 使用 ImageNet 数据集的均值和标准差
  - Mean: [0.485, 0.456, 0.406]
  - Std: [0.229, 0.224, 0.225]
  - 适用于使用预训练 MobileNet 的模型

- **无标准化 [0,255]**
  - 保持原始像素值范围
  - 适用于特殊训练的模型

### 2. 完整的调试系统

添加了详细的控制台日志输出：

- 模型加载信息（类型、输入/输出形状）
- 图像预处理步骤（原始值范围、处理后值范围）
- 预测过程（输入张量、输出张量、概率分布）
- 每个类别的预测概率

### 3. 改进的模型加载

- 明确记录模型类型（LayersModel 或 GraphModel）
- 输出模型摘要信息
- 验证标签加载

### 4. 用户友好的调试工具面板

在页面底部添加了调试工具卡片：
- 预处理模式下拉选择框
- 调试开关（启用/关闭控制台日志）
- 使用提示

## 🚀 使用方法

### 基本使用

1. 打开 `index.html`
2. 等待模型加载完成
3. 上传植物图片
4. 点击"开始识别"按钮

### 调试模式

1. **查看控制台**
   - 打开浏览器开发者工具（F12）
   - 切换到 Console 标签
   - 默认已启用调试信息

2. **切换预处理模式**
   - 如果预测结果不准确，尝试切换预处理模式
   - 建议按以下顺序测试：
     1. 简单归一化 [0,1]（默认）
     2. ImageNet 标准化
     3. 无标准化 [0,255]

3. **分析调试信息**
   ```
   === 开始预测 ===
   模型类型: layers
   原始图像形状: [height, width, 3]
   原始图像值范围: [0, 255]
   预处理模式: 简单归一化 [0,1]
   预处理后形状: [224, 224, 3]
   预处理后值范围: [0, 1]
   输入张量形状: [1, 224, 224, 3]
   输出张量形状: [1, 5]
   预测概率: [0.1, 0.2, 0.5, 0.15, 0.05]
   概率总和: 1.0
     齿尖椭圆叶: 10.00%
     齿状叶子: 20.00%
     小草: 50.00%
     圆椭圆叶: 15.00%
     竹叶: 5.00%
   === 预测完成 ===
   ```

## 📊 模型信息

- **模型类型**: MobileNetV2-based Sequential Model
- **输入尺寸**: 224 × 224 × 3
- **输出类别**: 5 种植物
  1. 齿尖椭圆叶
  2. 齿状叶子
  3. 小草
  4. 圆椭圆叶
  5. 竹叶

## 🔧 故障排除

### 预测结果仍然不一致？

1. **检查预处理模式**
   - 确认使用的预处理模式与训练时一致
   - 尝试不同的预处理模式

2. **查看控制台日志**
   - 检查概率总和是否接近 1.0
   - 确认输入张量值范围是否合理

3. **验证模型文件**
   - 确认 `model.json` 和 `model.weights.bin` 完整无损
   - 检查模型路径是否正确

4. **检查图像质量**
   - 确保上传的图像清晰
   - 避免过度压缩或失真的图像

### 常见问题

**Q: 所有预测概率都很低（如都小于 20%）**
- A: 可能是预处理模式不正确，尝试切换到其他模式

**Q: 概率总和不等于 1.0**
- A: 可能模型输出层已包含 softmax，检查模型配置

**Q: 预测结果与原始模型完全不同**
- A: 检查模型版本是否正确，确认使用的是同一个模型文件

## 📝 技术细节

### 预处理流程

```javascript
1. 从 <img> 元素读取像素 → [H, W, 3] uint8 [0-255]
2. 调整尺寸到 224×224 → [224, 224, 3] uint8 [0-255]
3. 转换为浮点数 → [224, 224, 3] float32 [0-255]
4. 应用归一化/标准化 → [224, 224, 3] float32 [取决于模式]
5. 添加批次维度 → [1, 224, 224, 3]
```

### 支持的模型格式

- TensorFlow.js LayersModel（推荐）
- TensorFlow.js GraphModel（兼容）

## 📧 联系方式

欢仔小组

---

**版本**: 1.1  
**更新日期**: 2025-10-14

